
{% extends 'customer-base.html' %}

{% block content %}

{% include 'company-logo.html' %}

<div class="flex place-content-center mt-10 mx-4">
    <div class="relative z-10 rounded-xl lg:w-1/2 sm:rounded-tl-xl lg:rounded-xl shadow-lg flex flex-col sm:flex-row xl:flex-row lg:-mr-8">
    <div class="max-w-md md:w-48 relative">
        <img src="{{ payment_link.product_image_url }}" alt="product image" class="relative md:absolute w-full h-80 md:h-full object-cover rounded-t-xl sm:rounded-l-xl sm:rounded-tr-none" />
    </div>
    <form class="flex-auto p-6" id="payment-form">
      <!-- form.hidden_tag()  INSERT HERE-->
        <div class="block">
            <div class="flex flex-wrap mb-2">
                <h1 class="flex-auto text-xl font-semibold">
                  Pay Now
                </h1>
                <div class="text-xl font-semibold text-gray-500">
                    Total due now: £{{'%0.2f'| format((plan.monthly_price * 12)|float)}}
                </div>
            </div>

            <p class="text-sm text-gray-500 text-center my-3">
              You are subscribing to the {{ plan.description }} for £{{ plan.monthly_price }} per month{{ plan.billing_schedule }}. Your subscription will start now.
            </p>

            <div id="card-element" class="mt-4 text-md shadow-sm border border-gray-300 focus:ring-black focus:border-black block sm:text-md border-black w-full rounded-md rounded-md bg-gray-50 text-black py-1 px-2">
                <!-- Elements will create input elements here -->
            </div>
            
            <!-- We'll put the error messages in this element -->
            <div id="card-element-errors" role="alert"></div>
            
            <div class="flex space-x-3 mb-4 text-sm font-medium mt-4">
                <div class="flex-auto flex space-x-3 text-center">
                    <button class="w-full flex items-center justify-center rounded-md bg-black text-white py-2" id="submit" type="submit">Subscribe</button>
                </div>
              </div>


      </div>
      <p class="text-sm text-gray-500">
        You can cancel your subscription anytime.
      </p>
    </form>
</div>
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
  <script type="text/javascript">
    let stripe = Stripe('pk_test_qblFNYngBkEdjEZ16jxxoWSM');
    let elements = stripe.elements();

    let style = {
    base: {
        color: "#32325d",
        fontSize: '1.5rem',
    }
    };

    let card = elements.create("card", { 
        style: style,
        hidePostalCode: true,
     });
    card.mount("#card-element")

    card.on('change', function (event) {
      displayError(event);
    });
    function displayError(event) {
      changeLoadingStatePrices(false);
      let displayError = document.getElementById('card-element-errors');
      if (event.error) {
        displayError.textContent = event.error.message;
      } else {
        displayError.textContent = '';
      }
    }

    const btn = document.querySelector('#submit-payment-btn');
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const nameInput = document.getElementById('name');
      let clientSecret = '{{ client_secret }}';

      // Create payment method and confirm payment intent.
      stripe.confirmCardPayment(clientSecret, {
        receipt_email: '{{ user.email }}',
        payment_method: {
          card: cardElement,
          billing_details: {
            name: '{{ user.full_name }}',
            email: '{{ user.email }}',
            phone: '{{ user.phone }}',
          },
        }
      }).then((result) => {
        if(result.error) {
          alert(result.error.message);
        } else {
          // Successful subscription payment
          window.location.replace("{{ url_for('welcome') }}");
        }
      });
    });

    /* ------- UI helpers ------- */

    // Shows a success message when the payment is complete
    var orderComplete = function(paymentIntentId) {
      loading(false);
      document.querySelector("button").disabled = true;
    };

    // Show the customer the error from Stripe if their card fails to charge
    var showError = function(errorMsgText) {
      loading(false);
      var errorMsg = document.querySelector("#card-error");
      errorMsg.textContent = errorMsgText;
      setTimeout(function() {
        errorMsg.textContent = "";
      }, 4000);
    };

    // Show a spinner on payment submission
    var loading = function(isLoading) {
      if (isLoading) {
        // Disable the button and show a spinner
        document.querySelector("button").disabled = true;
        document.querySelector("#spinner").classList.remove("hidden");
        document.querySelector("#button-text").classList.add("hidden");
      } else {
        document.querySelector("button").disabled = false;
        document.querySelector("#spinner").classList.add("hidden");
        document.querySelector("#button-text").classList.remove("hidden");
      }
    };
  </script>

{% endblock %}
